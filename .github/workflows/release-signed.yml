name: Create Signed Release

on:
  push:
    tags:
      - 'v*.*.*-signed'  # v1.0.0-signed å½¢å¼ã®ã‚¿ã‚°ã§ãƒˆãƒªã‚¬ãƒ¼

env:
  APP_NAME: ClipboardImageSaver
  XCODE_VERSION: "15.2"

permissions:
  contents: write
  pull-requests: write

jobs:
  build-and-release:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
        
    - name: Get version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        VERSION=${VERSION%-signed}  # -signed ã‚’å‰Šé™¤
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        
    - name: Cache Swift packages
      uses: actions/cache@v4
      with:
        path: .build
        key: ${{ runner.os }}-swift-${{ hashFiles('Package.swift') }}
        restore-keys: |
          ${{ runner.os }}-swift-
          
    - name: Resolve Swift dependencies
      run: swift package resolve
      
    - name: Build application
      run: swift build -c release
      
    - name: Create application bundle
      run: |
        # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ³ãƒ‰ãƒ«ä½œæˆ
        mkdir -p dist/${{ env.APP_NAME }}.app/Contents/MacOS
        mkdir -p dist/${{ env.APP_NAME }}.app/Contents/Resources
        
        # å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ”ãƒ¼
        cp .build/release/${{ env.APP_NAME }} dist/${{ env.APP_NAME }}.app/Contents/MacOS/
        
        # å®Œå…¨ãªInfo.plistä½œæˆ
        cat > dist/${{ env.APP_NAME }}.app/Contents/Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>ClipboardImageSaver</string>
            <key>CFBundleIdentifier</key>
            <string>com.takekikuch.clipboardimagesaver</string>
            <key>CFBundleName</key>
            <string>Clipboard Image Saver</string>
            <key>CFBundleDisplayName</key>
            <string>Clipboard Image Saver</string>
            <key>CFBundleVersion</key>
            <string>${{ steps.version.outputs.VERSION }}</string>
            <key>CFBundleShortVersionString</key>
            <string>${{ steps.version.outputs.VERSION }}</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleSignature</key>
            <string>????</string>
            <key>CFBundleInfoDictionaryVersion</key>
            <string>6.0</string>
            <key>LSMinimumSystemVersion</key>
            <string>13.0</string>
            <key>LSUIElement</key>
            <true/>
            <key>NSHumanReadableCopyright</key>
            <string>Â© 2025 takekikuch</string>
            <key>NSAppleEventsUsageDescription</key>
            <string>Finderã®ç¾åœ¨ãƒ•ã‚©ãƒ«ãƒ€ã«ç”»åƒã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ã€‚</string>
            <key>NSAppleScriptEnabled</key>
            <true/>
            <key>NSServices</key>
            <array>
                <dict>
                    <key>NSMenuItem</key>
                    <dict>
                        <key>default</key>
                        <string>ç”»åƒã‚’ã“ã“ã«ä¿å­˜</string>
                    </dict>
                    <key>NSMessage</key>
                    <string>saveImageToCurrentFolder</string>
                    <key>NSRequiredContext</key>
                    <dict>
                        <key>NSApplicationIdentifier</key>
                        <string>com.apple.finder</string>
                    </dict>
                    <key>NSReturnTypes</key>
                    <array>
                        <string>NSStringPboardType</string>
                    </array>
                    <key>NSSendTypes</key>
                    <array>
                        <string>NSStringPboardType</string>
                    </array>
                </dict>
            </array>
        </dict>
        </plist>
        EOF
        
        # å®Ÿè¡Œæ¨©é™è¨­å®š
        chmod +x dist/${{ env.APP_NAME }}.app/Contents/MacOS/${{ env.APP_NAME }}
        
    - name: Setup notarization profile
      run: |
        # ã‚­ãƒ¼ãƒã‚§ãƒ¼ãƒ³ã‚¢ã‚¯ã‚»ã‚¹ã§notarytoolãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        xcrun notarytool store-credentials "notarytool-profile" \
          --apple-id "${{ secrets.APPLE_ID }}" \
          --password "${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}" \
          --team-id "${{ secrets.APPLE_TEAM_ID }}"
        
    - name: Sign and notarize application
      run: |
        # ã‚³ãƒ¼ãƒ‰ç½²å
        codesign --deep --force --verify --verbose \
          --sign "${{ secrets.DEVELOPER_ID_APPLICATION }}" \
          --entitlements ClipboardImageSaver.entitlements \
          --options runtime \
          "dist/${{ env.APP_NAME }}.app"
        
        # ç½²åæ¤œè¨¼
        codesign --verify --deep --strict --verbose=2 "dist/${{ env.APP_NAME }}.app"
        
        # ZIPä½œæˆ
        ditto -c -k --keepParent "dist/${{ env.APP_NAME }}.app" "signed-app.zip"
        
        # å…¬è¨¼ç”³è«‹
        xcrun notarytool submit "signed-app.zip" \
          --keychain-profile "notarytool-profile" \
          --wait
        
        # å…¬è¨¼ãƒã‚±ãƒƒãƒˆæ·»ä»˜
        xcrun stapler staple "dist/${{ env.APP_NAME }}.app"
        
        # æœ€çµ‚æ¤œè¨¼
        spctl --assess -vv --type exec "dist/${{ env.APP_NAME }}.app"
        
    - name: Create signed DMG
      run: |
        # DMGä½œæˆç”¨ã®ä¸€æ™‚ãƒ•ã‚©ãƒ«ãƒ€
        TEMP_DIR=$(mktemp -d)
        
        # ç½²åæ¸ˆã¿ã‚¢ãƒ—ãƒªã‚’ã‚³ãƒ”ãƒ¼
        cp -R "dist/${{ env.APP_NAME }}.app" "$TEMP_DIR/"
        
        # Applicationsãƒ•ã‚©ãƒ«ãƒ€ã¸ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯
        ln -s /Applications "$TEMP_DIR/Applications"
        
        # DMGä½œæˆ
        hdiutil create -srcfolder "$TEMP_DIR" \
          -volname "${{ env.APP_NAME }} ${{ steps.version.outputs.VERSION }} (Signed)" \
          -fs HFS+ \
          -fsargs "-c c=64,a=16,e=16" \
          -format UDZO \
          -imagekey zlib-level=9 \
          "dist/${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-signed.dmg"
        
        # DMGç½²åï¼ˆInstallerè¨¼æ˜æ›¸ãŒã‚ã‚Œã°ï¼‰
        if [ -n "${{ secrets.DEVELOPER_ID_INSTALLER }}" ]; then
          codesign --sign "${{ secrets.DEVELOPER_ID_INSTALLER }}" \
            "dist/${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-signed.dmg"
        fi
        
        # ä¸€æ™‚ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤
        rm -rf "$TEMP_DIR"
        
    - name: Calculate checksums
      id: checksums
      run: |
        cd dist
        DMG_FILE="${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-signed.dmg"
        if [ -f "$DMG_FILE" ]; then
          SHA256_DMG=$(shasum -a 256 "$DMG_FILE" | cut -d' ' -f1)
          echo "SHA256_DMG=$SHA256_DMG" >> $GITHUB_OUTPUT
          echo "DMG_FILE=$DMG_FILE" >> $GITHUB_OUTPUT
          echo "DMG_SIZE=$(du -h "$DMG_FILE" | cut -f1)" >> $GITHUB_OUTPUT
        fi
        
    - name: Generate release notes
      id: release_notes
      run: |
        cat > release_notes.md << EOF
        # ${{ env.APP_NAME }} ${{ steps.version.outputs.VERSION }} (ç½²åç‰ˆ)
        
        ## ğŸ‰ ç½²åãƒ»å…¬è¨¼æ¸ˆã¿ãƒªãƒªãƒ¼ã‚¹
        
        ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯**Developer IDè¨¼æ˜æ›¸**ã§ç½²åã•ã‚Œã€**Appleã«ã‚ˆã‚‹å…¬è¨¼**ã‚’å—ã‘ã¦ã„ã‚‹ãŸã‚ã€macOSã®Gatekeeperè­¦å‘Šãªã—ã§å®Ÿè¡Œã§ãã¾ã™ã€‚
        
        ## ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ / Download
        
        - **DMG (ç½²åç‰ˆ)**: [${{ steps.checksums.outputs.DMG_FILE }}](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.TAG_NAME }}/${{ steps.checksums.outputs.DMG_FILE }})
        
        ## ğŸ“‹ ãƒã‚§ãƒƒã‚¯ã‚µãƒ  / Checksums
        
        - **SHA256**: \`${{ steps.checksums.outputs.SHA256_DMG }}\`
        - **ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º**: ${{ steps.checksums.outputs.DMG_SIZE }}
        
        ## ğŸ”§ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³• / Installation
        
        1. DMGãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        2. DMGã‚’ãƒã‚¦ãƒ³ãƒˆã—ã€${{ env.APP_NAME }}.appã‚’Applicationsãƒ•ã‚©ãƒ«ãƒ€ã«ãƒ‰ãƒ©ãƒƒã‚°
        3. **é€šå¸¸é€šã‚Šãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§èµ·å‹•å¯èƒ½**ï¼ˆè­¦å‘Šãªã—ï¼‰
        4. åˆå›èµ·å‹•æ™‚ã«æ¨©é™è¨­å®šã‚’è¡Œã†ï¼ˆã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãƒ»Apple Eventsï¼‰
        
        ## âœ¨ ä¸»ãªæ©Ÿèƒ½ / Features
        
        - **ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ**: âŒ˜+Shift+V ã§ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ç”»åƒã‚’ä¿å­˜
        - **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼**: ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ç”»åƒã®å³åº§ãªè¡¨ç¤º
        - **ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—**: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ç›´æ¥ä¿å­˜
        - **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé¸æŠ**: PNGãƒ»JPEGå½¢å¼ã§ã®ä¿å­˜
        - **ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º**: ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«åãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ›´å¯èƒ½
        
        ## ğŸ› ï¸ ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶ / System Requirements
        
        - macOS 13.0 ä»¥é™
        - ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£æ¨©é™
        - Apple Eventsæ¨©é™
        
        ## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ / Security
        
        - âœ… **Developer IDè¨¼æ˜æ›¸**ã«ã‚ˆã‚‹ç½²å
        - âœ… **Appleå…¬è¨¼æ¸ˆã¿**ï¼ˆGatekeeperæ‰¿èªï¼‰
        - âœ… **Hardened Runtime**å¯¾å¿œ
        - âœ… **ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹**ã‚³ãƒ¼ãƒ‰å…¬é–‹
        
        ## ğŸ“ ã‚µãƒãƒ¼ãƒˆ / Support
        
        ãƒã‚°å ±å‘Šã‚„æ©Ÿèƒ½è¦æœ›ã¯[Issues](https://github.com/${{ github.repository }}/issues)ã‹ã‚‰ãŠé¡˜ã„ã—ã¾ã™ã€‚
        
        ---
        
        **ğŸŠ å®Œå…¨ã«å®‰å…¨ãªç½²åç‰ˆãƒªãƒªãƒ¼ã‚¹ã§ã™ï¼è­¦å‘Šãªã—ã§å®Ÿè¡Œã§ãã¾ã™ã€‚**
        EOF
        
    - name: Create GitHub Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # GitHub CLIã§ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
        gh release create ${{ steps.version.outputs.TAG_NAME }} \
          --title "${{ env.APP_NAME }} ${{ steps.version.outputs.VERSION }} (ç½²åç‰ˆ)" \
          --notes-file release_notes.md \
          --draft=false \
          --prerelease=false \
          dist/${{ steps.checksums.outputs.DMG_FILE }} \
          README.md \
          LICENSE