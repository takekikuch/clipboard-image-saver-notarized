name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'  # v1.0.0 å½¢å¼ã®ã‚¿ã‚°ã§ãƒˆãƒªã‚¬ãƒ¼

env:
  APP_NAME: ClipboardImageSaver
  XCODE_VERSION: "15.2"

jobs:
  build-and-release:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
        
    - name: Get version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        
    - name: Cache Swift packages
      uses: actions/cache@v4
      with:
        path: .build
        key: ${{ runner.os }}-swift-${{ hashFiles('Package.swift') }}
        restore-keys: |
          ${{ runner.os }}-swift-
          
    - name: Resolve Swift dependencies
      run: swift package resolve
      
    - name: Build application
      run: swift build -c release
      
    - name: Create application bundle
      run: |
        # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ³ãƒ‰ãƒ«ä½œæˆ
        mkdir -p dist/${{ env.APP_NAME }}.app/Contents/MacOS
        mkdir -p dist/${{ env.APP_NAME }}.app/Contents/Resources
        
        # å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ”ãƒ¼
        cp .build/release/${{ env.APP_NAME }} dist/${{ env.APP_NAME }}.app/Contents/MacOS/
        
        # Info.plistä½œæˆ
        cat > dist/${{ env.APP_NAME }}.app/Contents/Info.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>${{ env.APP_NAME }}</string>
            <key>CFBundleIdentifier</key>
            <string>com.takekikuch.${{ env.APP_NAME }}</string>
            <key>CFBundleName</key>
            <string>${{ env.APP_NAME }}</string>
            <key>CFBundleVersion</key>
            <string>${{ steps.version.outputs.VERSION }}</string>
            <key>CFBundleShortVersionString</key>
            <string>${{ steps.version.outputs.VERSION }}</string>
            <key>LSUIElement</key>
            <true/>
            <key>NSAppleEventsUsageDescription</key>
            <string>Finderã®ç¾åœ¨ãƒ•ã‚©ãƒ«ãƒ€ã«ç”»åƒã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ã€‚</string>
            <key>NSHumanReadableCopyright</key>
            <string>Â© 2025 takekikuch</string>
        </dict>
        </plist>
        EOF
        
    - name: Create DMG (without signing)
      run: |
        # assetsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
        mkdir -p assets
        
        # DMGä½œæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œï¼ˆç½²åãªã—ç‰ˆï¼‰
        ./scripts/create_dmg.sh ${{ steps.version.outputs.VERSION }} dist/${{ env.APP_NAME }}.app
        
    - name: Calculate checksums
      id: checksums
      run: |
        cd dist
        DMG_FILE="${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}.dmg"
        if [ -f "$DMG_FILE" ]; then
          SHA256_DMG=$(shasum -a 256 "$DMG_FILE" | cut -d' ' -f1)
          echo "SHA256_DMG=$SHA256_DMG" >> $GITHUB_OUTPUT
          echo "DMG_FILE=$DMG_FILE" >> $GITHUB_OUTPUT
          echo "DMG_SIZE=$(du -h "$DMG_FILE" | cut -f1)" >> $GITHUB_OUTPUT
        fi
        
    - name: Generate release notes
      id: release_notes
      run: |
        cat > release_notes.md << EOF
        # ${{ env.APP_NAME }} ${{ steps.version.outputs.VERSION }}
        
        ## ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ / Download
        
        - **DMG (æ¨å¥¨)**: [${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}.dmg](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.TAG_NAME }}/${{ steps.checksums.outputs.DMG_FILE }})
        
        ## ğŸ“‹ ãƒã‚§ãƒƒã‚¯ã‚µãƒ  / Checksums
        
        - **SHA256**: \`${{ steps.checksums.outputs.SHA256_DMG }}\`
        - **ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º**: ${{ steps.checksums.outputs.DMG_SIZE }}
        
        ## ğŸ”§ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³• / Installation
        
        1. DMGãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        2. DMGã‚’ãƒã‚¦ãƒ³ãƒˆã—ã€${{ env.APP_NAME }}.appã‚’Applicationsãƒ•ã‚©ãƒ«ãƒ€ã«ãƒ‰ãƒ©ãƒƒã‚°
        3. åˆå›èµ·å‹•æ™‚ã«æ¨©é™è¨­å®šã‚’è¡Œã†ï¼ˆã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãƒ»Apple Eventsï¼‰
        
        ## âœ¨ ä¸»ãªæ©Ÿèƒ½ / Features
        
        - **ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ**: âŒ˜+Shift+V ã§ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ç”»åƒã‚’ä¿å­˜
        - **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼**: ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ç”»åƒã®å³åº§ãªè¡¨ç¤º
        - **ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—**: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ç›´æ¥ä¿å­˜
        - **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé¸æŠ**: PNGãƒ»JPEGå½¢å¼ã§ã®ä¿å­˜
        - **ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º**: ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«åãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ›´å¯èƒ½
        
        ## ğŸ› ï¸ ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶ / System Requirements
        
        - macOS 13.0 ä»¥é™
        - ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£æ¨©é™
        - Apple Eventsæ¨©é™
        
        ## ğŸ“ ã‚µãƒãƒ¼ãƒˆ / Support
        
        ãƒã‚°å ±å‘Šã‚„æ©Ÿèƒ½è¦æœ›ã¯[Issues](https://github.com/${{ github.repository }}/issues)ã‹ã‚‰ãŠé¡˜ã„ã—ã¾ã™ã€‚
        
        ---
        
        **æ³¨æ„**: ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯æœªç½²åã§ã™ã€‚æœ¬æ ¼çš„ãªé…å¸ƒã«ã¯ Developer ID è¨¼æ˜æ›¸ã«ã‚ˆã‚‹ç½²åãŒå¿…è¦ã§ã™ã€‚
        EOF
        
    - name: Create GitHub Release
      uses: actions/create-release@v1
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.TAG_NAME }}
        release_name: ${{ env.APP_NAME }} ${{ steps.version.outputs.VERSION }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        
    - name: Upload DMG to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: dist/${{ steps.checksums.outputs.DMG_FILE }}
        asset_name: ${{ steps.checksums.outputs.DMG_FILE }}
        asset_content_type: application/x-apple-diskimage
        
    - name: Upload README to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: README.md
        asset_name: README.md
        asset_content_type: text/markdown
        
    - name: Upload LICENSE to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: LICENSE
        asset_name: LICENSE
        asset_content_type: text/plain